@startuml Get Entity
!theme plain
title Get User - Hexagonal Architecture Flow

actor Client
participant "UserController\n(Input Adapter)" as Controller
participant "UserUseCase\n(Domain Port)" as UseCase
participant "UserService\n(Application Service)" as Service
participant "UserMapper\n(Application Layer)" as Mapper
participant "UserRepositoryPort\n(Domain Port)" as RepoPort
participant "UserRepositoryAdapter\n(Output Adapter)" as RepoAdapter
participant "JpaUserRepository\n(Infrastructure)" as JpaRepo
database "H2 Database" as DB

Client -> Controller: GET /users/{userId}
activate Controller
note right: REST endpoint with\npath variable validation

Controller -> Controller: validatePathVariable(@PathVariable String userId)
note right: UUID format validation

Controller -> UseCase: get(userId)
activate UseCase
note right: Domain port interface\ndefines contract

UseCase -> Service: get(userId)
activate Service
note right: Application service\nimplements use case

Service -> RepoPort: findById(userId)
activate RepoPort
RepoPort -> RepoAdapter: findById(userId)
activate RepoAdapter
RepoAdapter -> JpaRepo: findById(userId)
activate JpaRepo
JpaRepo -> DB: SELECT * FROM users WHERE id = ?
DB --> JpaRepo: Optional<UserDbo>
JpaRepo --> RepoAdapter: Optional<UserDbo>
deactivate JpaRepo

alt User Found
    RepoAdapter -> Mapper: toDomain(UserDbo)
    activate Mapper
    note right: Convert JPA entity\nto domain object
    Mapper --> RepoAdapter: User
    deactivate Mapper
    
    RepoAdapter --> RepoPort: Optional<User>
    deactivate RepoAdapter
    RepoPort --> Service: Optional<User>
    deactivate RepoPort
    
    Service -> Mapper: toGetResponse(User)
    activate Mapper
    note right: Convert domain to\nresponse DTO
    Mapper --> Service: GetUserResponseContent
    deactivate Mapper
    
    Service --> UseCase: GetUserResponseContent
    deactivate Service
    UseCase --> Controller: GetUserResponseContent
    deactivate UseCase
    
    Controller --> Client: HTTP 200\n{"userId": "...", "username": "johndoe", "email": "john@example.com", "firstName": "John", "lastName": "Doe", "status": "ACTIVE", "createdAt": "...", "updatedAt": "..."}
    deactivate Controller

else User Not Found
    RepoAdapter --> RepoPort: Optional.empty()
    deactivate RepoAdapter
    RepoPort --> Service: Optional.empty()
    deactivate RepoPort
    
    Service --> UseCase: NotFoundException("User not found")
    deactivate Service
    UseCase --> Controller: NotFoundException
    deactivate UseCase
    
    Controller --> Client: HTTP 404\n{"message": "User not found", "timestamp": "...", "path": "/users/..."}
    deactivate Controller
    note right: GlobalExceptionHandler\nhandles the exception
end

note over Service
  Business Logic:
  - Validates user existence
  - Handles not found scenarios
  - Applies read permissions
  - Logs access patterns
  - Caches frequently accessed data
end note

note over Mapper
  Read Mapping Features:
  - Domain to DTO conversion
  - Field selection and filtering
  - Data transformation
  - Null safety handling
  - Performance optimization
end note

note over RepoAdapter
  Query Features:
  - Efficient database queries
  - Connection pooling
  - Query optimization
  - Result caching
  - Monitoring and metrics
end note

@enduml