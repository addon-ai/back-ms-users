@startuml Delete Entity
!theme plain
title Delete User - Hexagonal Architecture Flow

actor Client
participant "UserController\n(Input Adapter)" as Controller
participant "UserUseCase\n(Domain Port)" as UseCase
participant "UserService\n(Application Service)" as Service
participant "UserMapper\n(Application Layer)" as Mapper
participant "UserRepositoryPort\n(Domain Port)" as RepoPort
participant "UserRepositoryAdapter\n(Output Adapter)" as RepoAdapter
participant "JpaUserRepository\n(Infrastructure)" as JpaRepo
database "H2 Database" as DB

Client -> Controller: DELETE /users/{userId}
activate Controller
note right: REST endpoint with\npath variable validation

Controller -> Controller: validatePathVariable(@PathVariable String userId)
note right: UUID format validation

Controller -> UseCase: delete(userId)
activate UseCase
note right: Domain port interface\ndefines contract

UseCase -> Service: delete(userId)
activate Service
note right: Application service\nimplements use case

' First, verify user exists
Service -> RepoPort: findById(userId)
activate RepoPort
RepoPort -> RepoAdapter: findById(userId)
activate RepoAdapter
RepoAdapter -> JpaRepo: findById(userId)
activate JpaRepo
JpaRepo -> DB: SELECT * FROM users WHERE id = ?
DB --> JpaRepo: Optional<UserDbo>
JpaRepo --> RepoAdapter: Optional<UserDbo>
deactivate JpaRepo

alt User Found
    RepoAdapter -> Mapper: toDomain(UserDbo)
    activate Mapper
    note right: Convert JPA entity\nto domain object
    Mapper --> RepoAdapter: User
    deactivate Mapper
    
    RepoAdapter --> RepoPort: Optional<User>
    deactivate RepoAdapter
    RepoPort --> Service: Optional<User>
    deactivate RepoPort
    
    ' Check business rules before deletion
    Service -> Service: validateDeletionRules(User)
    note right: Business validation:\n- Check dependencies\n- Verify permissions\n- Apply soft delete rules
    
    ' Perform deletion
    Service -> RepoPort: deleteById(userId)
    activate RepoPort
    RepoPort -> RepoAdapter: deleteById(userId)
    activate RepoAdapter
    RepoAdapter -> JpaRepo: deleteById(userId)
    activate JpaRepo
    JpaRepo -> DB: DELETE FROM users WHERE id = ?
    DB --> JpaRepo: void
    JpaRepo --> RepoAdapter: void
    deactivate JpaRepo
    RepoAdapter --> RepoPort: void
    deactivate RepoAdapter
    RepoPort --> Service: void
    deactivate RepoPort
    
    ' Build success response
    Service -> Service: buildDeleteResponse()
    note right: Create response:\n- deleted = true\n- message = "User deleted successfully"
    
    Service --> UseCase: DeleteUserResponseContent
    deactivate Service
    UseCase --> Controller: DeleteUserResponseContent
    deactivate UseCase
    
    Controller --> Client: HTTP 200\n{"deleted": true, "message": "User deleted successfully"}
    deactivate Controller

else User Not Found
    RepoAdapter --> RepoPort: Optional.empty()
    deactivate RepoAdapter
    RepoPort --> Service: Optional.empty()
    deactivate RepoPort
    
    Service --> UseCase: NotFoundException("User not found")
    deactivate Service
    UseCase --> Controller: NotFoundException
    deactivate UseCase
    
    Controller --> Client: HTTP 404\n{"message": "User not found", "timestamp": "...", "path": "/users/..."}
    deactivate Controller
    note right: GlobalExceptionHandler\nhandles the exception
end

note over Service
  Business Logic:
  - Validates user existence
  - Checks deletion constraints
  - Handles cascade deletions
  - Implements soft delete if needed
  - Logs deletion events
  - Maintains referential integrity
end note

note over RepoAdapter
  Deletion Features:
  - Transactional deletion
  - Constraint checking
  - Cascade handling
  - Audit trail logging
  - Performance optimization
  - Error handling
end note

note over DB
  Database Operations:
  - Foreign key constraints
  - Cascade delete rules
  - Transaction isolation
  - Rollback on failure
  - Index maintenance
end note

@enduml