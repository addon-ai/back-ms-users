@startuml Complex Operations
!theme plain
title Complex Operations - Location Service (GetRegionsByCountry)

actor Client
participant "LocationController\n(Input Adapter)" as Controller
participant "LocationUseCase\n(Domain Port)" as UseCase
participant "LocationService\n(Application Service)" as Service
participant "LocationMapper\n(Application Layer)" as Mapper
participant "RegionRepositoryPort\n(Domain Port)" as RepoPort
participant "RegionRepositoryAdapter\n(Output Adapter)" as RepoAdapter
participant "JpaRegionRepository\n(Infrastructure)" as JpaRepo
database "H2 Database" as DB

Client -> Controller: GET /locations/regions-by-country?countryId=USA
activate Controller
note right: Complex operation endpoint\nwith query parameters

Controller -> Controller: validateQueryParams(@RequestParam String countryId)
note right: Parameter validation:\n- countryId required\n- format validation

Controller -> UseCase: getRegionsByCountry()
activate UseCase
note right: Complex operation\ndefined in use case

UseCase -> Service: getRegionsByCountry()
activate Service
note right: Business logic for\ncomplex geographic query

' Service may need to validate country exists first
Service -> Service: validateCountryExists(countryId)
note right: Business rule:\nCountry must exist before\nquerying regions

' Execute complex query
Service -> RepoPort: findByCountryId(countryId)
activate RepoPort
RepoPort -> RepoAdapter: findByCountryId(countryId)
activate RepoAdapter

RepoAdapter -> JpaRepo: findByCountryIdAndStatusActive(countryId)
activate JpaRepo
note right: Complex query:\nSELECT r.* FROM regions r\nWHERE r.country_id = ?\nAND r.status = 'ACTIVE'\nORDER BY r.name
JpaRepo -> DB: Complex JOIN query with filtering
DB --> JpaRepo: List<RegionDbo>
JpaRepo --> RepoAdapter: List<RegionDbo>
deactivate JpaRepo

RepoAdapter -> Mapper: toDomainList(List<RegionDbo>)
activate Mapper
note right: Batch convert regions\nto domain objects
Mapper --> RepoAdapter: List<Region>
deactivate Mapper

RepoAdapter --> RepoPort: List<Region>
deactivate RepoAdapter
RepoPort --> Service: List<Region>
deactivate RepoPort

' Apply business logic and sorting
Service -> Service: applyBusinessRules(List<Region>)
note right: Business processing:\n- Sort by name\n- Filter by permissions\n- Apply regional rules

' Map to complex response DTO
Service -> Mapper: toGetRegionsByCountryResponse(List<Region>)
activate Mapper
note right: Complex mapping:\n- Region details\n- Country information\n- Metadata inclusion
Mapper --> Service: GetRegionsByCountryResponseContent
deactivate Mapper

Service --> UseCase: GetRegionsByCountryResponseContent
deactivate Service
UseCase --> Controller: GetRegionsByCountryResponseContent
deactivate UseCase

Controller --> Client: HTTP 200\n{"regions": [{"regionId": "...", "name": "California", "code": "CA", "countryId": "USA", ...}], "country": {"name": "United States", ...}}
deactivate Controller

note over Service
  Complex Business Logic:
  - Multi-entity validation
  - Geographic data processing
  - Hierarchical data handling
  - Business rule application
  - Performance optimization
  - Caching strategies
end note

note over Mapper
  Complex Mapping:
  - Nested object mapping
  - Hierarchical data structure
  - Metadata enrichment
  - Performance optimization
  - Memory efficient processing
end note

note over RepoAdapter
  Complex Query Features:
  - Multi-table joins
  - Advanced filtering
  - Sorting and ordering
  - Index optimization
  - Query performance monitoring
  - Result caching
end note

@enduml